<!DOCTYPE html>
<html lang="en">
<head>
    <title>Cart Information</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/index.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"
            integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
</head>
<body>
<table id="orderUser" align="center">
    <tr>
        <td colspan="2" align="right"><button onclick="goHome()">ë’¤ë¡œê°€ê¸°</button></td>
    </tr>
    <tr>
        <td colspan="2" align="center"><h1>ğŸ›’ ë‚´ ì¥ë°”êµ¬ë‹ˆ ğŸ›’</h1></td>
    </tr>
</table>

<table align="center">
    <tr>
        <td colspan="2" align="left">----- ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ -----</td>
    </tr>
</table>

<table id="cartInfo" align="center">
    <!-- ì¹´íŠ¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
</table>

<!-- ì£¼ë¬¸ ì£¼ì†Œ ì…ë ¥ í¼ -->
<table align="center">
    <tr>
        <td><label for="address">ì£¼ë¬¸ ì£¼ì†Œ : </label></td>
        <td><input type="text" id="address" placeholder="ì£¼ë¬¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”"></td>
    </tr>
    <tr>
        <td colspan="2" align="right"><button id="orderButton">ì£¼ë¬¸í•˜ê¸°</button></td>
    </tr>
    <tr>
        <td colspan="2" class="spacing-bottom"></td>
    </tr>
    <tr>
        <td colspan="2" class="spacing-bottom"></td>
    </tr>
    <tr>
        <td class="textbox" colspan="2" align="right"><span id="connectionStatus"></span></td>    <!-- ì—°ê²° ìƒíƒœ í‘œì‹œ -->
    </tr>
</table>

<table align="center">
    <tr>
        <td id="messageOutput" class="textbox"></td>
    </tr>
</table>

<script>
    const orderButton = document.getElementById("orderButton");
    let webSocket;

    $(document).ready(function () {
        const auth = getToken();
        if (auth !== undefined && auth !== '') {
            $.ajaxPrefilter(function (options, originalOptions, jqXHR) {
                jqXHR.setRequestHeader('Authorization', auth);
            });
        } else {
            window.location.href = host + '/user/login-page';
            return;
        }
        // í˜ì´ì§€ ì§„ì… ì‹œì— user infoë¥¼ ë¶ˆëŸ¬ì˜¨ í›„ ê·¸ idì— ë§ëŠ” ì±„íŒ…ë°© ì‹ ì„¤(ìˆë‹¤ë©´ ë°±ì—”ë“œì—ì„œ ì‹ ì„¤ ëŒ€ì‹  ê¸°ì¡´ ì±„íŒ…ë°©ì„ ì¶œë ¥)
        $.ajax({
            type: 'GET',
            url: `/api/user-info`,
            contentType: 'application/json',
        })
            .done(function (res, status, xhr) {
                $.ajax({
                    type: 'POST',
                    url: "/chat",
                    data: JSON.stringify({id: res.userid}),
                    contentType: 'application/json',
                    success: function (res) {
                        console.log(res)
                    }
                })
            })

        $.ajax({
            type: 'GET',
            url: `/api/cart`,
            success: function (cart) {
                const orderUserTable = document.getElementById("orderUser");
                const userItem = document.createElement("table");
                userItem.innerHTML= `
                                    <tr>
                                        <td>ì‚¬ìš©ìëª… : </td>
                                        <td class="textbox">${cart.username}</td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" class="spacing-bottom"></td>
                                    </tr>
                                    `
                orderUserTable.appendChild(userItem);

                const cartInfoTable = document.getElementById("cartInfo");
                cart.addedMenuList.forEach(menu => {
                    const cartItem = document.createElement("table");
                    cartItem.innerHTML = `
                        <tr>
                            <td>ë©”ë‰´ : </td>
                            <td class="textbox">${menu.menuResponseDto.name}</td>
                        </tr>
                        <tr>
                            <td>ìˆ˜ëŸ‰ : </td>
                            <td class="textbox">${menu.count}</td>
                        </tr>
                        <tr>
                            <td colspan="2"><hr></td>
                        </tr>
                        `;
                    cartInfoTable.appendChild(cartItem);
                })
            }
        })
        connectWebSocket();
    })

    // /api/order ì—”ë“œí¬ì¸íŠ¸ë¡œ ì£¼ë¬¸ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
    orderButton.addEventListener("click", () => {
        console.log("test1")
        const addressInput = document.getElementById("address");
        const address = addressInput.value;

        if (address) {
            createOrder(address);
        } else {
            alert("ì£¼ë¬¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        }
    });

    function createOrder(adr) {
        const formData = {
            address: adr
        };
        $.ajax({
            type: 'POST',
            url: "/api/order",
            data: JSON.stringify(formData),
            contentType: 'application/json',
            success: function (response) {
                // ìƒì  ìƒì„± ì„±ê³µ ë©”ì‹œì§€ë¥¼ í‘œì‹œ
                console.log(response)

                // ìƒì ì„ ìƒì„±í•˜ê³  ìƒì  ìƒì„± ìš”ì²­ì„ ë³´ë‚´ê¸°

                // ìƒì  ìƒì„± ì‹œ
                $.ajax({
                        type: 'POST',
                        url: "/chat",
                        data:JSON.stringify({id:response.userid}),
                        contentType: 'application/json',
                        success: function (res){
                            console.log(res)
                        }
                })
                console.log(1)
                // websocket ì‹œì‘

                const messageOutput = document.getElementById("messageOutput");
                const connectionStatus = document.getElementById("connectionStatus"); // ì—°ê²° ìƒíƒœ í‘œì‹œ
                console.log(connectionStatus)
                // ì›¹ ì†Œì¼“ ì—°ê²° í•¨ìˆ˜
                console.log(2)

                console.log(3)
                // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
                const message = `{
                "type":"ORDER",
                "roomId":"${response.storeownerid}",
                "sender":"${response.username}",
                "message":"${response.id}ë²ˆ ì£¼ë¬¸ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!"
                }`
                console.log(7)
                //const message = messageInput.value;
                webSocket.send(message);
                // send(message);
                console.log(8)
                messageOutput.innerHTML += `<p>ì†¡ì‹ : ${message}</p>`;
                console.log(10)

            },
            error: function (error) {
                // ìƒì  ìƒì„± ì‹¤íŒ¨ ë©”ì‹œì§€ë¥¼ í‘œì‹œ
                $('#updateResult').html('<p>Error creating store.</p>');
            }
        });

    }
    function connectWebSocket() {
        const socketUrl = 'ws://43.201.67.57:8080/ws/chat';
        if (!webSocket && socketUrl.trim() !== "") {
            webSocket = new WebSocket(socketUrl);

            // ì›¹ ì†Œì¼“ ì—°ê²° ì„±ê³µ ì‹œ
            webSocket.onopen = (event) => {
                console.log("WebSocket ì—°ê²° ì„±ê³µ!");
                connectionStatus.textContent = "ì—°ê²°ë¨"; // ì—°ê²° ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
            };

            // ì›¹ ì†Œì¼“ ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ
            webSocket.onmessage = (event) => {
                const message = event.data;
                messageOutput.innerHTML += `<p>ìˆ˜ì‹ : ${message}</p>`;
            };

            // ì›¹ ì†Œì¼“ ì—°ê²° ì¢…ë£Œ ì‹œ
            webSocket.onclose = (event) => {
                console.log("WebSocket ì—°ê²° ì¢…ë£Œ!");
                connectionStatus.textContent = "ì—°ê²° ì¢…ë£Œ"; // ì—°ê²° ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
            };
        }
    }
</script>
</body>
</html>
